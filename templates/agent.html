{% extends "base.html" %}

{% block title %}Agent - RTA Break Tracker{% endblock %}

{% block content %}
<div class="app-container">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1>ğŸ–¥ï¸ RTA Break Tracker</h1>
        </div>
        <div class="header-right">
            <span class="user-info">ğŸ‘¤ {{ user.full_name }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-danger">ğŸšª Logout</a>
        </div>
    </header>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="content-grid">
            <!-- Left Panel: Break Actions -->
            <div class="panel panel-main">
                <div class="panel-content">
                    <!-- Status -->
                    <div class="status-box {% if active_break %}status-on-break{% else %}status-at-work{% endif %}" id="statusBox">
                        {% if active_break %}
                            <span id="statusText">â³ On Break (<span id="elapsedTime">{{ active_break.get_elapsed_minutes() }}</span> min)</span>
                        {% else %}
                            <span id="statusText">ğŸŸ¢ Status: At Work</span>
                        {% endif %}
                    </div>
                    
                    {% if is_off_day %}
                    <div class="info-banner" style="background: #fff3cd; border: 1px solid #ffc107; padding: 10px; border-radius: 8px; margin-bottom: 20px;">
                        <strong>ğŸ–ï¸ Today is your off day</strong>
                        {% for offday in upcoming_offdays %}
                        {% if offday.off_date == today %}
                        {% if offday.reason %}
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #856404;">Reason: {{ offday.reason }}</p>
                        {% endif %}
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Break Type Selection -->
                    <h3>Select Break Type:</h3>
                    <div class="break-types" id="breakTypes">
                        {% for key, info in break_types.items() %}
                        <button type="button" class="break-type-btn {% if active_break %}disabled{% endif %}" 
                                data-type="{{ key }}"
                                style="--break-color: {{ info.color }}">
                            <span class="emoji">{{ info.emoji }}</span>
                            <span class="name">{{ info.name }}</span>
                            <span class="duration">({{ break_durations[key] }} min)</span>
                        </button>
                        {% endfor %}
                    </div>
                    
                    <!-- Screenshot Upload -->
                    <h3>Upload Screenshot:</h3>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content">
                            <div class="upload-icon" id="uploadIcon">ğŸ“·</div>
                            <p>Browse file or Paste from clipboard (Ctrl+V)</p>
                            <div class="upload-buttons">
                                <label class="btn btn-primary">
                                    ğŸ“ Browse
                                    <input type="file" id="fileInput" accept="image/*" hidden>
                                </label>
                                <button type="button" class="btn btn-secondary" id="pasteBtn">ğŸ“‹ Paste</button>
                            </div>
                        </div>
                    </div>
                    <p class="selected-file" id="selectedFile"></p>
                    
                    <!-- Submit Button -->
                    <button type="button" class="btn btn-primary btn-block btn-large" id="submitBtn" disabled>
                        {% if active_break %}
                            ğŸ Submit Break End
                        {% else %}
                            ğŸš€ Submit Break Start
                        {% endif %}
                    </button>
                    
                    <p class="message" id="message"></p>
                    
                    {% if today_shift %}
                    <div class="info-banner" style="background: #e7f3ff; border: 1px solid #1a73e8; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <strong style="display: block; margin-bottom: 8px; font-size: 16px;">ğŸ“… Today's Shift Schedule</strong>
                        <div style="font-size: 14px; color: #1a73e8; line-height: 1.6;">
                            <div style="margin-bottom: 5px;">
                                <strong>Start:</strong> {{ today_shift.start_date.strftime('%A, %B %d') }} at {{ today_shift.start_time.strftime('%I:%M %p') }}
                            </div>
                            <div style="margin-bottom: 5px;">
                                <strong>End:</strong> {{ today_shift.end_date.strftime('%A, %B %d') }} at {{ today_shift.end_time.strftime('%I:%M %p') }}
                            </div>
                            {% if today_shift.start_date != today_shift.end_date %}
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #b3d9ff; font-size: 12px; color: #666;">
                                â„¹ï¸ This is a multi-day shift spanning {{ ((today_shift.end_date - today_shift.start_date).days + 1) }} day(s)
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if upcoming_shifts|length > 0 %}
                    <div class="info-banner" style="background: #f0f0f0; border: 1px solid #ccc; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <strong style="display: block; margin-bottom: 10px; font-size: 16px;">ğŸ“… Upcoming Shifts (Next 7 Days)</strong>
                        <div style="font-size: 13px; line-height: 1.8;">
                            {% for shift in upcoming_shifts[:5] %}
                            <div style="margin-bottom: 12px; padding-bottom: 12px; {% if not loop.last %}border-bottom: 1px solid #ddd;{% endif %}">
                                <div style="font-weight: 600; color: #333; margin-bottom: 4px;">
                                    {{ shift.start_date.strftime('%A, %B %d') }}
                                </div>
                                <div style="color: #666; font-size: 12px;">
                                    <span>â° {{ shift.start_time.strftime('%I:%M %p') }}</span>
                                    <span style="margin: 0 8px;">â†’</span>
                                    <span>â° {{ shift.end_date.strftime('%b %d') }} {{ shift.end_time.strftime('%I:%M %p') }}</span>
                                </div>
                                {% if shift.start_date != shift.end_date %}
                                <div style="margin-top: 4px; font-size: 11px; color: #888; font-style: italic;">
                                    (Multi-day shift)
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if upcoming_offdays|length > 0 %}
                    <div class="info-banner" style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <strong style="display: block; margin-bottom: 10px; font-size: 16px;">ğŸ–ï¸ Upcoming Off Days (Next 7 Days)</strong>
                        <div style="font-size: 13px; line-height: 1.8;">
                            {% for offday in upcoming_offdays[:5] %}
                            <div style="margin-bottom: 8px; padding: 6px 0; {% if not loop.last %}border-bottom: 1px solid #ffe69c;{% endif %}">
                                <div style="font-weight: 600; color: #856404;">
                                    ğŸ“† {{ offday.off_date.strftime('%A, %B %d') }}
                                </div>
                                {% if offday.reason %}
                                <div style="font-size: 12px; color: #856404; margin-top: 3px; font-style: italic;">
                                    Reason: {{ offday.reason }}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Right Panel: Today's History -->
            <div class="panel panel-sidebar">
                <div class="panel-header">
                    <h3>ğŸ“‹ Today's Breaks</h3>
                    <button class="btn btn-icon" onclick="location.reload()">ğŸ”„</button>
                </div>
                <div class="panel-content">
                    <div class="break-history" id="breakHistory">
                        {% if today_breaks %}
                            {% for br in today_breaks %}
                            <div class="history-card {% if br.is_active() %}active{% elif br.is_overdue %}overdue{% else %}completed{% endif %}">
                                <div class="history-info">
                                    {% if br.break_type in ['punch_in', 'punch_out'] %}
                                        <span class="history-type">{{ br.get_break_info().emoji }} {{ br.start_time.strftime('%H:%M') }}</span>
                                    {% else %}
                                        <span class="history-type">{{ br.get_break_info().emoji }} {{ br.start_time.strftime('%I:%M %p') }}</span>
                                        {% if br.end_time %}
                                            <span> â†’ {{ br.end_time.strftime('%I:%M %p') }}</span>
                                        {% else %}
                                            <span> â†’ â³ On Break...</span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <div class="history-status">
                                    {% if br.is_active() %}
                                        ({{ br.get_elapsed_minutes() }} min elapsed)
                                    {% elif br.is_overdue %}
                                        ({{ br.duration_minutes }} min) âš ï¸
                                    {% else %}
                                        ({{ br.duration_minutes }} min) âœ…
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="empty-message">No breaks recorded today</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Pass data to JavaScript
    window.agentData = {
        hasActiveBreak: {% if active_break %}true{% else %}false{% endif %},
        activeBreakId: {% if active_break %}{{ active_break.id }}{% else %}null{% endif %},
        activeBreakStart: {% if active_break %}"{{ active_break.start_time.isoformat() }}"{% else %}null{% endif %},
        punchStatus: '{{ punch_status }}',
        breakInfo: {{ break_types|tojson }},
        breakDurations: {{ break_durations|tojson }}
    };
    
    // Disable break buttons if punched out
    document.addEventListener('DOMContentLoaded', function() {
        if (window.agentData.punchStatus === 'punched_out') {
            document.querySelectorAll('.break-type-btn').forEach(btn => {
                if (btn.dataset.type !== 'punch_in' && btn.dataset.type !== 'punch_out') {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'You have already punched out for the day';
                }
            });
        } else if (window.agentData.punchStatus === 'not_punched_in') {
            // Disable all breaks except punch_in
            document.querySelectorAll('.break-type-btn').forEach(btn => {
                if (btn.dataset.type !== 'punch_in') {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'You must punch in first';
                }
            });
        }
    });
</script>
{% endblock %}

