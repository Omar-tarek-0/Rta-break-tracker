{% extends "base.html" %}

{% block title %}Agent - RTA Break Tracker{% endblock %}

{% block content %}
<div class="app-container">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1>üñ•Ô∏è RTA Break Tracker</h1>
        </div>
        <div class="header-right">
            <span class="user-info">üë§ {{ user.full_name }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-danger">üö™ Logout</a>
        </div>
    </header>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="content-grid">
            <!-- Left Panel: Break Actions -->
            <div class="panel panel-main">
                <div class="panel-content">
                    <!-- Status -->
                    <div class="status-box {% if active_break %}status-on-break{% else %}status-at-work{% endif %}" id="statusBox">
                        {% if active_break %}
                            <span id="statusText">‚è≥ On {{ active_break.get_break_info().name }} (<span id="elapsedTime">{{ active_break.get_elapsed_minutes() }}</span> min)</span>
                            <p class="status-hint">Started at {{ active_break.start_time.strftime('%I:%M %p') }} ‚Ä¢ Allowed: {{ active_break.get_allowed_duration() }} min</p>
                        {% else %}
                            <span id="statusText">üü¢ Status: At Work</span>
                        {% endif %}
                    </div>
                    
                    <!-- Break Type Selection -->
                    <h3>Select Break Type:</h3>
                    <div class="break-types" id="breakTypes">
                        {% for key, info in break_types.items() %}
                        <button type="button" class="break-type-btn {% if active_break %}disabled{% endif %}" 
                                data-type="{{ key }}"
                                style="--break-color: {{ info.color }}">
                            <span class="emoji">{{ info.emoji }}</span>
                            <span class="name">{{ info.name }}</span>
                            <span class="duration">{% if break_durations[key] > 0 %}({{ break_durations[key] }} min){% else %}(Instant){% endif %}</span>
                        </button>
                        {% endfor %}
                    </div>
                    
                    <!-- Screenshot Upload -->
                    <h3>Upload Screenshot:</h3>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content">
                            <div class="upload-icon" id="uploadIcon">üì∑</div>
                            <p>Browse file or Paste from clipboard (Ctrl+V)</p>
                            <div class="upload-buttons">
                                <label class="btn btn-primary">
                                    üìÅ Browse
                                    <input type="file" id="fileInput" accept="image/*" hidden>
                                </label>
                                <button type="button" class="btn btn-secondary" id="pasteBtn">üìã Paste</button>
                            </div>
                        </div>
                    </div>
                    <p class="selected-file" id="selectedFile"></p>
                    
                    <!-- Submit Button -->
                    <button type="button" class="btn btn-primary btn-block btn-large" id="submitBtn" disabled>
                        {% if active_break %}
                            üèÅ Submit Break End
                        {% else %}
                            üöÄ Submit Break Start
                        {% endif %}
                    </button>
                    
                    <p class="message" id="message"></p>
                </div>
            </div>
            
            <!-- Right Panel: Today's History & Schedule -->
            <div class="panel panel-sidebar">
                <div class="panel-header">
                    <h3>üìã Today's Breaks</h3>
                    <button class="btn btn-icon" onclick="location.reload()">üîÑ</button>
                </div>
                <div class="panel-content">
                    <div class="break-history" id="breakHistory">
                        {% if today_breaks %}
                            {% for br in today_breaks %}
                            <div class="history-card {% if br.break_type == 'punch_in' %}punch-in{% elif br.break_type == 'punch_out' %}punch-out{% elif br.is_active() %}active{% elif br.is_overdue %}overdue{% else %}completed{% endif %}">
                                <div class="history-info">
                                    <span class="history-type">{{ br.get_break_info().emoji }} {{ br.get_break_info().name }}</span>
                                    <span class="history-time">{{ br.start_time.strftime('%I:%M %p') }}</span>
                                </div>
                                <div class="history-status">
                                    {% if br.break_type in ['punch_in', 'punch_out'] %}
                                        ‚úÖ
                                    {% elif br.is_active() %}
                                        ({{ br.get_elapsed_minutes() }} min elapsed)
                                    {% elif br.is_overdue %}
                                        ({{ br.duration_minutes }} min) ‚ö†Ô∏è
                                    {% else %}
                                        ({{ br.duration_minutes }} min) ‚úÖ
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="empty-message">No activity recorded today</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Shift Schedule Panel -->
            <div class="panel panel-sidebar" style="margin-top: 20px;">
                <div class="panel-header">
                    <h3>üìÖ My Schedule (Next 2 Weeks)</h3>
                </div>
                <div class="panel-content">
                    <div class="shift-schedule" id="shiftSchedule">
                        {% for date_info in schedule_dates %}
                            {% set check_date = date_info.date %}
                            {% set shift = date_info.shift %}
                            <div class="shift-day {% if check_date == today %}shift-today{% elif shift %}shift-assigned{% else %}shift-empty{% endif %}">
                                <div class="shift-date">
                                    <span class="shift-day-name">{{ check_date.strftime('%a') }}</span>
                                    <span class="shift-day-number">{{ check_date.strftime('%d') }}</span>
                                    <span class="shift-month">{{ check_date.strftime('%b') }}</span>
                                </div>
                                <div class="shift-time">
                                    {% if shift %}
                                        <span class="shift-time-range">{{ shift.start_time.strftime('%I:%M %p') }} - {{ shift.end_time.strftime('%I:%M %p') }}</span>
                                    {% elif check_date == today %}
                                        <span class="shift-time-range no-shift">No shift assigned</span>
                                    {% else %}
                                        <span class="shift-time-range no-shift">‚Äî</span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Pass data to JavaScript
    window.agentData = {
        hasActiveBreak: {% if active_break %}true{% else %}false{% endif %},
        activeBreakId: {% if active_break %}{{ active_break.id }}{% else %}null{% endif %},
        activeBreakStart: {% if active_break %}"{{ active_break.start_time.isoformat() }}"{% else %}null{% endif %},
        activeBreakType: {% if active_break %}"{{ active_break.break_type }}"{% else %}null{% endif %},
        activeBreakAllowedDuration: {% if active_break %}{{ active_break.get_allowed_duration() }}{% else %}null{% endif %},
        breakInfo: {{ break_types|tojson }},
        breakDurations: {{ break_durations|tojson }}
    };
</script>
{% endblock %}
