{% extends "base.html" %}

{% block title %}RTM Dashboard - RTA Break Tracker{% endblock %}

{% block content %}
<div class="app-container">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1>ğŸ–¥ï¸ RTA Break Tracker</h1>
            <span class="badge badge-primary">RTM</span>
            <span class="header-date">ğŸ“… {{ now().strftime('%A, %B %d, %Y') if now else '' }}</span>
        </div>
        <div class="header-right">
            <span class="user-info">ğŸ‘¤ {{ user.full_name }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-danger">ğŸšª Logout</a>
        </div>
    </header>
    
    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-value" style="color: #1a73e8;">{{ total_agents }}</div>
            <div class="stat-label">ğŸ‘¥ Agents</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ total_breaks_today }}</div>
            <div class="stat-label">ğŸ“‹ Breaks Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #fbbc04;">{{ active_breaks }}</div>
            <div class="stat-label">â³ On Break</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #ea4335;">{{ overdue_breaks }}</div>
            <div class="stat-label">âš ï¸ Overdue</div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="dashboard-content">
        <!-- Sidebar: Filters -->
        <aside class="sidebar">
            <div class="filter-section">
                <h4>ğŸ” Search</h4>
                <input type="text" id="searchInput" placeholder="Search agents..." class="form-input">
            </div>
            
            <div class="filter-section">
                <h4>ğŸ“… Date Range</h4>
                <div class="date-buttons">
                    <button class="btn btn-sm btn-primary" data-date="today">Today</button>
                    <button class="btn btn-sm" data-date="yesterday">Yesterday</button>
                    <button class="btn btn-sm" data-date="week">7 Days</button>
                </div>
                <div class="custom-date">
                    <input type="date" id="customDate" class="form-input">
                    <button class="btn btn-sm btn-primary" id="goDateBtn">Go</button>
                </div>
                <p class="current-filter" id="currentDateLabel">ğŸ“† Showing: Today</p>
            </div>
            
            <div class="filter-section">
                <h4>ğŸ‘¤ Filter by Agent</h4>
                <select id="agentFilter" class="form-select">
                    <option value="">All Agents</option>
                    {% for agent in agents %}
                    <option value="{{ agent.id }}">{{ agent.full_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-section">
                <h4>â˜• Filter by Type</h4>
                <select id="typeFilter" class="form-select">
                    <option value="">All Types</option>
                    {% for key, info in break_types.items() %}
                    <option value="{{ key }}">{{ info.emoji }} {{ info.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <button class="btn btn-primary btn-block" onclick="loadBreaks()">ğŸ”„ Refresh Data</button>
            
            <hr class="divider">
            
            <div class="filter-section">
                <h4>âš™ï¸ Agent Management</h4>
                <button class="btn btn-success btn-block" onclick="showAddAgentModal()">â• Add New Agent</button>
                <p class="agent-count">Total: {{ total_agents }} agents</p>
            </div>
            
            <hr class="divider">
            
            <div class="filter-section">
                <h4>ğŸ“… Schedule Management</h4>
                <button class="btn btn-primary btn-block" onclick="showSchedulesModal()" style="margin-bottom: 10px;">ğŸ“‹ View All Schedules</button>
                <button class="btn btn-success btn-block" onclick="showAddShiftModal()" style="margin-bottom: 10px;">â• Add Shift</button>
                <button class="btn btn-warning btn-block" onclick="showAddOffDayModal()">ğŸ–ï¸ Add Off Day</button>
            </div>
            
            <hr class="divider">
            
            <div class="filter-section">
                <h4>âš™ï¸ Break Management</h4>
                <button class="btn btn-primary btn-block" onclick="showManualBreakModal()">â• Add Manual Break</button>
            </div>
        </aside>
        
        <!-- Main: Break Records & Reports -->
        <main class="main-area">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="breaks" onclick="switchTab('breaks')">ğŸ“‹ Break Records</button>
                <button class="tab-btn" data-tab="reports" onclick="switchTab('reports')">ğŸ“Š Reports & Export</button>
            </div>
            
            <!-- Break Records Tab -->
            <div id="tab-breaks" class="tab-content active">
                <div class="main-header">
                    <h2>ğŸ“‹ Break Records</h2>
                    <span id="recordsCount" class="records-count"></span>
                </div>
                
                <div id="breaksContainer" class="breaks-container">
                    <div class="loading">Loading breaks...</div>
                </div>
            </div>
            
            <!-- Reports Tab -->
            <div id="tab-reports" class="tab-content" style="display: none;">
                <div class="main-header">
                    <h2>ğŸ“Š Reports & Export</h2>
                </div>
                
                <div class="reports-section">
                    <!-- Date Range -->
                    <div class="report-controls">
                        <div class="form-group">
                            <label>ğŸ“… Date Range</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="date" id="reportStartDate" class="form-input">
                                <span>to</span>
                                <input type="date" id="reportEndDate" class="form-input">
                                <button class="btn btn-sm" onclick="setReportPeriod('today')">Today</button>
                                <button class="btn btn-sm" onclick="setReportPeriod('week')">7 Days</button>
                                <button class="btn btn-sm" onclick="setReportPeriod('month')">30 Days</button>
                                <button class="btn btn-primary" onclick="loadMetrics()">ğŸ“Š Generate Report</button>
                                <button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ Export to Excel</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="summary-cards" id="summaryCards" style="display: none;">
                        <div class="summary-card">
                            <div class="summary-label">Avg Utilization</div>
                            <div class="summary-value" id="avgUtilization">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Avg Adherence</div>
                            <div class="summary-value" id="avgAdherence">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Avg Conformance</div>
                            <div class="summary-value" id="avgConformance">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Total Incidents</div>
                            <div class="summary-value" id="totalIncidents">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Exceeding Breaks</div>
                            <div class="summary-value" id="totalExceeding">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Emergency Breaks</div>
                            <div class="summary-value" id="totalEmergency">-</div>
                        </div>
                    </div>
                    
                    <!-- Metrics Table -->
                    <div class="metrics-table-container">
                        <table class="metrics-table">
                            <thead>
                                <tr>
                                    <th>Agent Name</th>
                                    <th>Scheduled Hours</th>
                                    <th>Total Breaks</th>
                                    <th>Break Time</th>
                                    <th>Exceeding</th>
                                    <th>Incidents</th>
                                    <th>Emergency</th>
                                    <th>Overtime</th>
                                    <th>Overtime (min)</th>
                                    <th>Lunch</th>
                                    <th>Coaching</th>
                                    <th>Utilization %</th>
                                    <th>Adherence %</th>
                                    <th>Conformance %</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="metricsTableBody">
                                <tr>
                                    <td colspan="15" class="empty-message">Select date range and click "Generate Report"</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Add Agent Modal -->
<div id="addAgentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>â• Add New Agent</h3>
            <button class="modal-close" onclick="hideAddAgentModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="agentName" class="form-input" placeholder="Enter agent's full name">
            </div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="agentUsername" class="form-input" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="agentPassword" class="form-input" placeholder="Enter password">
            </div>
            <p id="agentError" class="error-message"></p>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="hideAddAgentModal()">Cancel</button>
            <button class="btn btn-success" onclick="createAgent()">âœ… Add Agent</button>
        </div>
    </div>
</div>

<!-- Image Viewer Modal -->
<div id="imageModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="imageModalTitle">Screenshot</h3>
            <button class="modal-close" onclick="hideImageModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <img id="modalImage" src="" alt="Screenshot" class="modal-image">
        </div>
    </div>
</div>

<!-- Schedules View Modal -->
<div id="schedulesModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>ğŸ“‹ View All Schedules</h3>
            <button class="modal-close" onclick="hideSchedulesModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ğŸ“… Date Range</label>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <input type="date" id="schedulesStartDate" class="form-input">
                    <span>to</span>
                    <input type="date" id="schedulesEndDate" class="form-input">
                    <button class="btn btn-primary" onclick="loadSchedules()">ğŸ” Load Schedules</button>
                </div>
            </div>
            <div id="schedulesContainer" style="max-height: 500px; overflow-y: auto;">
                <div class="empty-message">Select date range and click "Load Schedules"</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="hideSchedulesModal()">Close</button>
        </div>
    </div>
</div>

<!-- Manual Break Entry Modal -->
<div id="manualBreakModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>â• Add Manual Break</h3>
            <button class="modal-close" onclick="hideManualBreakModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ğŸ‘¤ Agent</label>
                <select id="manualBreakAgent" class="form-select">
                    <option value="">Select Agent</option>
                    {% for agent in agents %}
                    <option value="{{ agent.id }}">{{ agent.full_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>â˜• Break Type</label>
                <select id="manualBreakType" class="form-select">
                    <option value="">Select Break Type</option>
                    {% for key, info in break_types.items() %}
                    <option value="{{ key }}">{{ info.emoji }} {{ info.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>ğŸ“… Start Date & Time</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="date" id="manualBreakStartDate" class="form-input">
                    <input type="time" id="manualBreakStartTime" class="form-input">
                </div>
            </div>
            <div class="form-group">
                <label>ğŸ“… End Date & Time <span style="color: var(--text-secondary); font-size: 11px;">(Optional)</span></label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="date" id="manualBreakEndDate" class="form-input" placeholder="End date (optional)">
                    <input type="time" id="manualBreakEndTime" class="form-input" placeholder="End time (optional)">
                </div>
                <small style="color: var(--text-secondary); font-size: 11px;">Leave empty for active breaks or instant actions (punch in/out). If only time is provided, start date will be used.</small>
            </div>
            <div class="form-group">
                <label>ğŸ“ Notes (Optional)</label>
                <textarea id="manualBreakNotes" class="form-input" rows="3" placeholder="Enter any notes about this break..."></textarea>
            </div>
            <div class="form-group">
                <label>ğŸ“· Start Screenshot (Optional)</label>
                <input type="file" id="manualBreakStartScreenshot" class="form-input" accept="image/*">
            </div>
            <div class="form-group">
                <label>ğŸ“· End Screenshot (Optional)</label>
                <input type="file" id="manualBreakEndScreenshot" class="form-input" accept="image/*">
            </div>
            <p id="manualBreakError" class="error-message"></p>
            <p id="manualBreakSuccess" class="success-message" style="display: none;"></p>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="hideManualBreakModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitManualBreak()">âœ… Create Break</button>
        </div>
    </div>
</div>

<!-- Add Shift Modal -->
<div id="addShiftModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>â• Add Shift Schedule</h3>
            <button class="modal-close" onclick="hideAddShiftModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label style="font-weight: 600; margin-bottom: 10px; display: block;">ğŸ‘¤ Select Agents (Multiple Selection)</label>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: #fff;">
                    {% for agent in agents %}
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; margin: 4px 0; border-radius: 4px; user-select: none; transition: background 0.2s;" 
                           onmouseover="this.style.background='#f5f5f5'" 
                           onmouseout="this.style.background='transparent'">
                        <input type="checkbox" class="shift-agent-checkbox" value="{{ agent.id }}" style="margin-right: 8px; cursor: pointer;">
                        <span>{{ agent.full_name }}</span>
                    </label>
                    {% endfor %}
                </div>
                <small style="color: #666; font-size: 11px; display: block; margin-top: 5px;">
                    Select one or more agents to assign this schedule to
                </small>
            </div>
            
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <label style="font-weight: 600; margin-bottom: 10px; display: block;">â° Shift Time (Daily)</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">Start Time</label>
                        <input type="time" id="shiftStartTime" class="form-input">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">End Time</label>
                        <input type="time" id="shiftEndTime" class="form-input">
                    </div>
                </div>
                <small style="color: #666; font-size: 11px; display: block; margin-top: 5px;">
                    Example: 16:00 (4 PM) to 01:00 (1 AM) for overnight shifts
                </small>
            </div>
            
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <label style="font-weight: 600; margin-bottom: 10px; display: block;">ğŸ“… Schedule Period</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">From Date</label>
                        <input type="date" id="shiftPeriodStartDate" class="form-input">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">To Date</label>
                        <input type="date" id="shiftPeriodEndDate" class="form-input">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label style="font-weight: 600; margin-bottom: 10px; display: block;">ğŸ“† Working Days (Select days agent will work)</label>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 8px 12px; background: #fff; border: 2px solid #ddd; border-radius: 6px; user-select: none;">
                        <input type="checkbox" id="dayMon" value="0" style="margin-right: 6px;" checked>
                        <span>Monday</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 8px 12px; background: #fff; border: 2px solid #ddd; border-radius: 6px; user-select: none;">
                        <input type="checkbox" id="dayTue" value="1" style="margin-right: 6px;" checked>
                        <span>Tuesday</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 8px 12px; background: #fff; border: 2px solid #ddd; border-radius: 6px; user-select: none;">
                        <input type="checkbox" id="dayWed" value="2" style="margin-right: 6px;" checked>
                        <span>Wednesday</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 8px 12px; background: #fff; border: 2px solid #ddd; border-radius: 6px; user-select: none;">
                        <input type="checkbox" id="dayThu" value="3" style="margin-right: 6px;" checked>
                        <span>Thursday</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 8px 12px; background: #fff; border: 2px solid #ddd; border-radius: 6px; user-select: none;">
                        <input type="checkbox" id="dayFri" value="4" style="margin-right: 6px;" checked>
                        <span>Friday</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 8px 12px; background: #fff; border: 2px solid #ddd; border-radius: 6px; user-select: none;">
                        <input type="checkbox" id="daySat" value="5" style="margin-right: 6px;">
                        <span>Saturday</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 8px 12px; background: #fff; border: 2px solid #ddd; border-radius: 6px; user-select: none;">
                        <input type="checkbox" id="daySun" value="6" style="margin-right: 6px;">
                        <span>Sunday</span>
                    </label>
                </div>
                <small style="color: #666; font-size: 11px; display: block; margin-top: 8px;">
                    Unselected days will be automatically marked as off days
                </small>
            </div>
            
            <p id="addShiftError" class="error-message" style="display: none;"></p>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="hideAddShiftModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitShift()">ğŸ’¾ Save Schedule</button>
        </div>
    </div>
</div>

<!-- Add Off Day Modal -->
<div id="addOffDayModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ–ï¸ Add Off Day</h3>
            <button class="modal-close" onclick="hideAddOffDayModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ğŸ‘¤ Agent</label>
                <select id="offDayAgent" class="form-select">
                    <option value="">Select Agent</option>
                    {% for agent in agents %}
                    <option value="{{ agent.id }}">{{ agent.full_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>ğŸ“… Off Date</label>
                <input type="date" id="offDayDate" class="form-input">
            </div>
            <div class="form-group">
                <label>ğŸ“ Reason (Optional)</label>
                <input type="text" id="offDayReason" class="form-input" placeholder="e.g., Vacation, Sick Leave, etc.">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="hideAddOffDayModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitOffDay()">Save Off Day</button>
        </div>
    </div>
</div>

<script>
    // Initialize dashboard
    window.dashboardData = {
        startDate: '{{ date_filter }}',
        endDate: '{{ date_filter }}'
    };
</script>
{% endblock %}

