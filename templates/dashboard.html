{% extends "base.html" %}

{% block title %}RTM Dashboard - RTA Break Tracker{% endblock %}

{% block content %}
<div class="app-container">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1>ğŸ–¥ï¸ RTA Break Tracker</h1>
            <span class="badge badge-primary">RTM</span>
            <span class="header-date">ğŸ“… {{ now().strftime('%A, %B %d, %Y') if now else '' }}</span>
        </div>
        <div class="header-right">
            <span class="user-info">ğŸ‘¤ {{ user.full_name }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-danger">ğŸšª Logout</a>
        </div>
    </header>
    
    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-value" style="color: #1a73e8;">{{ total_agents }}</div>
            <div class="stat-label">ğŸ‘¥ Agents</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ total_breaks_today }}</div>
            <div class="stat-label">ğŸ“‹ Breaks Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #fbbc04;">{{ active_breaks }}</div>
            <div class="stat-label">â³ On Break</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #ea4335;">{{ overdue_breaks }}</div>
            <div class="stat-label">âš ï¸ Overdue</div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="dashboard-content">
        <!-- Sidebar: Filters -->
        <aside class="sidebar">
            <div class="filter-section">
                <h4>ğŸ” Search</h4>
                <input type="text" id="searchInput" placeholder="Search agents..." class="form-input">
            </div>
            
            <div class="filter-section">
                <h4>ğŸ“… Date Range</h4>
                <div class="date-buttons">
                    <button class="btn btn-sm btn-primary" data-date="today">Today</button>
                    <button class="btn btn-sm" data-date="yesterday">Yesterday</button>
                    <button class="btn btn-sm" data-date="week">7 Days</button>
                </div>
                <div class="custom-date">
                    <input type="date" id="customDate" class="form-input">
                    <button class="btn btn-sm btn-primary" id="goDateBtn">Go</button>
                </div>
                <p class="current-filter" id="currentDateLabel">ğŸ“† Showing: Today</p>
            </div>
            
            <div class="filter-section">
                <h4>ğŸ‘¤ Filter by Agent</h4>
                <select id="agentFilter" class="form-select">
                    <option value="">All Agents</option>
                    {% for agent in agents %}
                    <option value="{{ agent.id }}">{{ agent.full_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-section">
                <h4>â˜• Filter by Type</h4>
                <select id="typeFilter" class="form-select">
                    <option value="">All Types</option>
                    {% for key, info in break_types.items() %}
                    <option value="{{ key }}">{{ info.emoji }} {{ info.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <button class="btn btn-primary btn-block" onclick="loadBreaks()">ğŸ”„ Refresh Data</button>
            
            <hr class="divider">
            
            <div class="filter-section">
                <h4>âš™ï¸ Agent Management</h4>
                <button class="btn btn-success btn-block" onclick="showAddAgentModal()">â• Add New Agent</button>
                <p class="agent-count">Total: {{ total_agents }} agents</p>
            </div>
            
            <hr class="divider">
            
            <div class="filter-section">
                <h4>ğŸ“… Schedule Management</h4>
                <button class="btn btn-primary btn-block" onclick="showShiftModal()">ğŸ• Manage Shifts (2 Weeks)</button>
                <button class="btn btn-secondary btn-block" onclick="showSchedulesView()">ğŸ“‹ View All Schedules</button>
            </div>
            
            <hr class="divider">
            
            <div class="filter-section">
                <h4>âš™ï¸ Break Management</h4>
                <button class="btn btn-primary btn-block" onclick="showManualBreakModal()">â• Add Manual Break</button>
            </div>
        </aside>
        
        <!-- Main: Break Records & Reports -->
        <main class="main-area">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="breaks" onclick="switchTab('breaks')">ğŸ“‹ Break Records</button>
                <button class="tab-btn" data-tab="reports" onclick="switchTab('reports')">ğŸ“Š Reports & Export</button>
            </div>
            
            <!-- Break Records Tab -->
            <div id="tab-breaks" class="tab-content active">
                <div class="main-header">
                    <h2>ğŸ“‹ Break Records</h2>
                    <span id="recordsCount" class="records-count"></span>
                </div>
                
                <div id="breaksContainer" class="breaks-container">
                    <div class="loading">Loading breaks...</div>
                </div>
            </div>
            
            <!-- Reports & Export Tab -->
            <div id="tab-reports" class="tab-content" style="display: none;">
                <div class="main-header">
                    <h2>ğŸ“Š Reports & Export</h2>
                </div>
                
                <div class="reports-section">
                    <!-- Date Range -->
                    <div class="report-controls">
                        <div class="form-group">
                            <label>ğŸ“… Date Range</label>
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <input type="date" id="reportStartDate" class="form-input">
                                <span>to</span>
                                <input type="date" id="reportEndDate" class="form-input">
                                <button class="btn btn-sm" onclick="setReportPeriod('today')">Today</button>
                                <button class="btn btn-sm" onclick="setReportPeriod('week')">7 Days</button>
                                <button class="btn btn-sm" onclick="setReportPeriod('month')">30 Days</button>
                                <button class="btn btn-primary" onclick="loadMetrics()">ğŸ” Generate Report</button>
                                <button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ Export to Excel</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="summary-cards" id="summaryCards" style="display: none;">
                        <div class="summary-card">
                            <div class="summary-label">Avg Utilization</div>
                            <div class="summary-value" id="avgUtilization">0%</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Avg Adherence</div>
                            <div class="summary-value" id="avgAdherence">0%</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Avg Conformance</div>
                            <div class="summary-value" id="avgConformance">0%</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Total Incidents</div>
                            <div class="summary-value" id="totalIncidents">0</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Total Exceeding</div>
                            <div class="summary-value" id="totalExceeding">0 min</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Total Emergency</div>
                            <div class="summary-value" id="totalEmergency">0</div>
                        </div>
                    </div>
                    
                    <!-- Metrics Table -->
                    <div class="metrics-table-container" style="margin-top: 20px;">
                        <table class="data-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Agent Name</th>
                                    <th>Scheduled Hours</th>
                                    <th>Total Breaks</th>
                                    <th>Break Time</th>
                                    <th>Exceeding</th>
                                    <th>Incidents</th>
                                    <th>Emergency</th>
                                    <th>Lunch</th>
                                    <th>Coaching</th>
                                    <th>Overtime</th>
                                    <th>Compensation</th>
                                    <th>Utilization %</th>
                                    <th>Adherence %</th>
                                    <th>Conformance %</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="metricsTableBody">
                                <tr>
                                    <td colspan="15" class="empty-message">Select date range and click "Generate Report"</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Add Agent Modal -->
<div id="addAgentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>â• Add New Agent</h3>
            <button class="modal-close" onclick="hideAddAgentModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="agentName" class="form-input" placeholder="Enter agent's full name">
            </div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="agentUsername" class="form-input" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="agentPassword" class="form-input" placeholder="Enter password">
            </div>
            <p id="agentError" class="error-message"></p>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="hideAddAgentModal()">Cancel</button>
            <button class="btn btn-success" onclick="createAgent()">âœ… Add Agent</button>
        </div>
    </div>
</div>

<!-- Image Viewer Modal -->
<div id="imageModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="imageModalTitle">Screenshot</h3>
            <button class="modal-close" onclick="hideImageModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <img id="modalImage" src="" alt="Screenshot" class="modal-image">
        </div>
    </div>
</div>

<!-- Shift Management Modal -->
<div id="shiftModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>ğŸ• Shift Management (2 Weeks)</h3>
            <button class="modal-close" onclick="hideShiftModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="shift-form">
                <div class="form-group">
                    <label>ğŸ“… Date Range (Start - End)</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="date" id="shiftStartDate" class="form-input">
                        <span>to</span>
                        <input type="date" id="shiftEndDate" class="form-input">
                        <button class="btn btn-sm" onclick="setTwoWeeks()">Set 2 Weeks</button>
                    </div>
                    <small style="color: #666;">Select up to 14 days (2 weeks)</small>
                </div>
                
                <div class="form-group">
                    <label>â° Shift Time</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="time" id="shiftStartTime" class="form-input" value="08:00">
                        <span>to</span>
                        <input type="time" id="shiftEndTime" class="form-input" value="17:00">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Quick Templates:</label>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="btn btn-sm" onclick="setShiftTemplate('08:00', '17:00')">8 AM - 5 PM</button>
                        <button class="btn btn-sm" onclick="setShiftTemplate('11:00', '20:00')">11 AM - 8 PM</button>
                        <button class="btn btn-sm" onclick="setShiftTemplate('13:00', '22:00')">1 PM - 10 PM</button>
                        <button class="btn btn-sm" onclick="setShiftTemplate('16:00', '01:00')">4 PM - 1 AM</button>
                        <button class="btn btn-sm" onclick="setShiftTemplate('00:00', '09:00')">12 AM - 9 AM</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ğŸ‘¥ Select Agents</label>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                        <label style="display: block; margin-bottom: 5px;">
                            <input type="checkbox" id="selectAllAgents" onchange="toggleAllAgents()">
                            <strong>Select All</strong>
                        </label>
                        <div id="agentCheckboxes">
                            {% for agent in agents %}
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" class="agent-checkbox" value="{{ agent.id }}">
                                {{ agent.full_name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <p id="shiftError" class="error-message"></p>
                <p id="shiftSuccess" class="success-message" style="display: none;"></p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="hideShiftModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveBulkShifts()">âœ… Save Shifts for Selected Period</button>
        </div>
    </div>
</div>

<!-- Schedules View Modal -->
<div id="schedulesModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>ğŸ“‹ View All Assigned Schedules</h3>
            <button class="modal-close" onclick="hideSchedulesView()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="filter-section" style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <label>ğŸ“… Date Range:</label>
                    <input type="date" id="scheduleViewStartDate" class="form-input">
                    <span>to</span>
                    <input type="date" id="scheduleViewEndDate" class="form-input">
                    <button class="btn btn-sm btn-primary" onclick="loadSchedules()">ğŸ” Load Schedules</button>
                    <button class="btn btn-sm" onclick="setScheduleViewRange('today')">Today</button>
                    <button class="btn btn-sm" onclick="setScheduleViewRange('week')">This Week</button>
                    <button class="btn btn-sm" onclick="setScheduleViewRange('month')">This Month</button>
                </div>
            </div>
            
            <div id="schedulesLoading" class="loading" style="display: none;">Loading schedules...</div>
            <div id="schedulesError" class="error-message" style="display: none;"></div>
            
            <div id="schedulesContainer" style="overflow-x: auto;">
                <table class="data-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Agent Name</th>
                            <th>Date</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="schedulesTableBody">
                        <tr>
                            <td colspan="6" class="empty-message">Select a date range and click "Load Schedules"</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div id="schedulesSummary" style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; display: none;">
                <strong>Summary:</strong> <span id="schedulesCount">0</span> shifts found
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="hideSchedulesView()">Close</button>
        </div>
    </div>
</div>

<!-- Manual Break Entry Modal -->
<div id="manualBreakModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>â• Add Manual Break Record</h3>
            <button class="modal-close" onclick="hideManualBreakModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ğŸ‘¤ Select Agent *</label>
                <select id="manualBreakAgent" class="form-select" required>
                    <option value="">-- Select Agent --</option>
                    {% for agent in agents %}
                    <option value="{{ agent.id }}">{{ agent.full_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label>â˜• Break Type *</label>
                <select id="manualBreakType" class="form-select" required>
                    <option value="">-- Select Break Type --</option>
                    {% for key, info in break_types.items() %}
                    <option value="{{ key }}">{{ info.emoji }} {{ info.name }} ({{ break_durations[key] }} min)</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>ğŸ“… Start Date *</label>
                    <input type="date" id="manualBreakStartDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>ğŸ• Start Time *</label>
                    <input type="time" id="manualBreakStartTime" class="form-input" required>
                </div>
            </div>
            
            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>ğŸ“… End Date (Optional)</label>
                    <input type="date" id="manualBreakEndDate" class="form-input">
                    <small style="color: #666;">Leave empty for active break</small>
                </div>
                <div class="form-group">
                    <label>ğŸ• End Time (Optional)</label>
                    <input type="time" id="manualBreakEndTime" class="form-input">
                </div>
            </div>
            
            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>ğŸ“· Start Screenshot (Optional)</label>
                    <input type="file" id="manualBreakStartScreenshot" class="form-input" accept="image/*">
                    <small style="color: #666;">Upload screenshot for break start</small>
                </div>
                <div class="form-group">
                    <label>ğŸ“· End Screenshot (Optional)</label>
                    <input type="file" id="manualBreakEndScreenshot" class="form-input" accept="image/*">
                    <small style="color: #666;">Upload screenshot for break end</small>
                </div>
            </div>
            
            <div class="form-group">
                <label>ğŸ“ Notes (Optional)</label>
                <textarea id="manualBreakNotes" class="form-input" rows="3" placeholder="Add any notes about this break..."></textarea>
            </div>
            
            <p id="manualBreakError" class="error-message"></p>
            <p id="manualBreakSuccess" class="success-message" style="display: none;"></p>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="hideManualBreakModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitManualBreak()">âœ… Create Break Record</button>
        </div>
    </div>
</div>

<script>
    // Initialize dashboard
    window.dashboardData = {
        startDate: '{{ date_filter }}',
        endDate: '{{ date_filter }}'
    };
</script>
{% endblock %}

