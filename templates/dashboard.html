{% extends "base.html" %}

{% block title %}RTM Dashboard - RTA Break Tracker{% endblock %}

{% block content %}
<div class="app-container">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1>ğŸ–¥ï¸ RTA Break Tracker</h1>
            <span class="badge badge-primary">RTM</span>
            <span class="header-date">ğŸ“… {{ now().strftime('%A, %B %d, %Y') if now else '' }}</span>
        </div>
        <div class="header-right">
            <span class="user-info">ğŸ‘¤ {{ user.full_name }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-danger">ğŸšª Logout</a>
        </div>
    </header>
    
    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-value" style="color: #1a73e8;">{{ total_agents }}</div>
            <div class="stat-label">ğŸ‘¥ Agents</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ total_breaks_today }}</div>
            <div class="stat-label">ğŸ“‹ Breaks Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #fbbc04;">{{ active_breaks }}</div>
            <div class="stat-label">â³ On Break</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #ea4335;">{{ overdue_breaks }}</div>
            <div class="stat-label">âš ï¸ Overdue</div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="dashboard-content">
        <!-- Sidebar: Filters -->
        <aside class="sidebar">
            <div class="filter-section">
                <h4>ğŸ” Search</h4>
                <input type="text" id="searchInput" placeholder="Search agents..." class="form-input">
            </div>
            
            <div class="filter-section">
                <h4>ğŸ“… Date Range</h4>
                <div class="date-buttons">
                    <button class="btn btn-sm btn-primary" data-date="today">Today</button>
                    <button class="btn btn-sm" data-date="yesterday">Yesterday</button>
                    <button class="btn btn-sm" data-date="week">7 Days</button>
                </div>
                <div class="custom-date">
                    <input type="date" id="customDate" class="form-input">
                    <button class="btn btn-sm btn-primary" id="goDateBtn">Go</button>
                </div>
                <p class="current-filter" id="currentDateLabel">ğŸ“† Showing: Today</p>
            </div>
            
            <div class="filter-section">
                <h4>ğŸ‘¤ Filter by Agent</h4>
                <select id="agentFilter" class="form-select">
                    <option value="">All Agents</option>
                    {% for agent in agents %}
                    <option value="{{ agent.id }}">{{ agent.full_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-section">
                <h4>â˜• Filter by Type</h4>
                <select id="typeFilter" class="form-select">
                    <option value="">All Types</option>
                    {% for key, info in break_types.items() %}
                    <option value="{{ key }}">{{ info.emoji }} {{ info.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <button class="btn btn-primary btn-block" onclick="loadBreaks()">ğŸ”„ Refresh Data</button>
            
            <hr class="divider">
            
            <div class="filter-section">
                <h4>âš™ï¸ Agent Management</h4>
                <button class="btn btn-success btn-block" onclick="showAddAgentModal()">â• Add New Agent</button>
                <button class="btn btn-primary btn-block" onclick="showAgentList()">ğŸ“‹ Manage Agents</button>
                <p class="agent-count">Total: {{ total_agents }} agents</p>
            </div>
            
            <hr class="divider">
            
            <div class="filter-section">
                <h4>ğŸ“… Shift Management</h4>
                <button class="btn btn-primary btn-block" onclick="showShiftModal()">ğŸ• Manage Shifts (2 Weeks)</button>
            </div>
        </aside>
        
        <!-- Main: Break Records & Reports -->
        <main class="main-area">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="breaks" onclick="switchTab('breaks')">ğŸ“‹ Break Records</button>
                <button class="tab-btn" data-tab="reports" onclick="switchTab('reports')">ğŸ“Š Reports & Export</button>
            </div>
            
            <!-- Break Records Tab -->
            <div id="tab-breaks" class="tab-content active">
                <div class="main-header">
                    <h2>ğŸ“‹ Break Records</h2>
                    <span id="recordsCount" class="records-count"></span>
                </div>
                
                <div id="breaksContainer" class="breaks-container">
                    <div class="loading">Loading breaks...</div>
                </div>
            </div>
            
            <!-- Reports Tab -->
            <div id="tab-reports" class="tab-content" style="display: none;">
                <div class="main-header">
                    <h2>ğŸ“Š Reports & Export</h2>
                </div>
                
                <div class="reports-section">
                    <!-- Date Range -->
                    <div class="report-controls">
                        <div class="form-group">
                            <label>ğŸ“… Date Range</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="date" id="reportStartDate" class="form-input">
                                <span>to</span>
                                <input type="date" id="reportEndDate" class="form-input">
                                <button class="btn btn-sm" onclick="setReportPeriod('today')">Today</button>
                                <button class="btn btn-sm" onclick="setReportPeriod('week')">7 Days</button>
                                <button class="btn btn-sm" onclick="setReportPeriod('month')">30 Days</button>
                                <button class="btn btn-primary" onclick="loadMetrics()">ğŸ“Š Generate Report</button>
                                <button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ Export to Excel</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="summary-cards" id="summaryCards" style="display: none;">
                        <div class="summary-card">
                            <div class="summary-label">Avg Utilization</div>
                            <div class="summary-value" id="avgUtilization">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Avg Adherence</div>
                            <div class="summary-value" id="avgAdherence">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Avg Conformance</div>
                            <div class="summary-value" id="avgConformance">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Total Incidents</div>
                            <div class="summary-value" id="totalIncidents">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Exceeding Breaks</div>
                            <div class="summary-value" id="totalExceeding">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Emergency Breaks</div>
                            <div class="summary-value" id="totalEmergency">-</div>
                        </div>
                    </div>
                    
                    <!-- Metrics Table -->
                    <div class="metrics-table-container">
                        <table class="metrics-table">
                            <thead>
                                <tr>
                                    <th>Agent Name</th>
                                    <th>Scheduled Hours</th>
                                    <th>Total Breaks</th>
                                    <th>Break Time</th>
                                    <th>Exceeding</th>
                                    <th>Incidents</th>
                                    <th>Emergency</th>
                                    <th>Lunch</th>
                                    <th>Coaching</th>
                                    <th>Overtime</th>
                                    <th>Compensation</th>
                                    <th>Utilization %</th>
                                    <th>Adherence %</th>
                                    <th>Conformance %</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="metricsTableBody">
                                <tr>
                                    <td colspan="15" class="empty-message">Select date range and click "Generate Report"</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Add Agent Modal -->
<div id="addAgentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>â• Add New Agent</h3>
            <button class="modal-close" onclick="hideAddAgentModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="agentName" class="form-input" placeholder="Enter agent's full name">
            </div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="agentUsername" class="form-input" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="agentPassword" class="form-input" placeholder="Enter password">
            </div>
            <p id="agentError" class="error-message"></p>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="hideAddAgentModal()">Cancel</button>
            <button class="btn btn-success" onclick="createAgent()">âœ… Add Agent</button>
        </div>
    </div>
</div>

<!-- Image Viewer Modal -->
<div id="imageModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="imageModalTitle">Screenshot</h3>
            <button class="modal-close" onclick="hideImageModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <img id="modalImage" src="" alt="Screenshot" class="modal-image">
        </div>
    </div>
</div>

<!-- Agent List Modal -->
<div id="agentListModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>ğŸ“‹ Manage Agents</h3>
            <button class="modal-close" onclick="hideAgentList()">Ã—</button>
        </div>
        <div class="modal-body">
            <div id="agentListContainer" class="agent-list-container">
                <div class="loading">Loading agents...</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="hideAgentList()">Close</button>
        </div>
    </div>
</div>

<!-- Delete Agent Confirmation Modal -->
<div id="deleteAgentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>âš ï¸ Delete Agent</h3>
            <button class="modal-close" onclick="hideDeleteAgentModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p id="deleteAgentMessage">Are you sure you want to delete this agent?</p>
            <p class="warning-text">âš ï¸ This will permanently delete:</p>
            <ul class="warning-list">
                <li>All shifts for this agent</li>
                <li>All break records for this agent</li>
                <li>The agent account</li>
            </ul>
            <p class="warning-text"><strong>This action cannot be undone!</strong></p>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="hideDeleteAgentModal()">Cancel</button>
            <button class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteAgent()">ğŸ—‘ï¸ Delete Agent</button>
        </div>
    </div>
</div>

<!-- Shift Management Modal -->
<div id="shiftModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>ğŸ• Shift Management (2 Weeks)</h3>
            <button class="modal-close" onclick="hideShiftModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="shift-form">
                <div class="form-group">
                    <label>ğŸ“… Date Range (Start - End)</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="date" id="shiftStartDate" class="form-input">
                        <span>to</span>
                        <input type="date" id="shiftEndDate" class="form-input">
                        <button class="btn btn-sm" onclick="setTwoWeeks()">Set 2 Weeks</button>
                    </div>
                    <small style="color: #666;">Select up to 14 days (2 weeks)</small>
                </div>
                
                <div class="form-group">
                    <label>â° Shift Time</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="time" id="shiftStartTime" class="form-input" value="08:00">
                        <span>to</span>
                        <input type="time" id="shiftEndTime" class="form-input" value="17:00">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Quick Templates</label>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="btn btn-sm" onclick="setShiftTemplate('08:00', '17:00')">8 AM - 5 PM</button>
                        <button class="btn btn-sm" onclick="setShiftTemplate('11:00', '20:00')">11 AM - 8 PM</button>
                        <button class="btn btn-sm" onclick="setShiftTemplate('13:00', '22:00')">1 PM - 10 PM</button>
                        <button class="btn btn-sm" onclick="setShiftTemplate('16:00', '01:00')">4 PM - 1 AM</button>
                        <button class="btn btn-sm" onclick="setShiftTemplate('00:00', '09:00')">12 AM - 9 AM</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ğŸ‘¥ Select Agents</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="btn btn-sm" onclick="selectAllAgents()">Select All</button>
                        <button class="btn btn-sm" onclick="deselectAllAgents()">Deselect All</button>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                        {% for agent in agents %}
                        <label style="display: block; padding: 5px;">
                            <input type="checkbox" class="agent-checkbox" value="{{ agent.id }}" checked>
                            {{ agent.full_name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <p id="shiftError" class="error-message"></p>
                <p id="shiftSuccess" class="success-message" style="display: none;"></p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="hideShiftModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveBulkShifts()">âœ… Save Shifts for Selected Period</button>
        </div>
    </div>
</div>

<script>
    // Initialize dashboard
    window.dashboardData = {
        startDate: '{{ date_filter }}',
        endDate: '{{ date_filter }}'
    };
</script>
{% endblock %}

